import requests
from bs4 import BeautifulSoup
import json
import pandas as pd

# Заголовки для имитации браузера
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
}

# URL для поиска компаний с тегами "типография" и "полиграфия" в Новосибирске
# Примечание: 2GIS не предоставляет прямой URL с двойным тегом, поэтому это примерный запрос
base_url = "https://2gis.ru/novosibirsk/search/типография%20полиграфия"

def parse_2gis():
    try:
        # Получаем страницу
        response = requests.get(base_url, headers=headers, timeout=10)
        response.raise_for_status()
        soup = BeautifulSoup(response.text, 'html.parser')

        # Список для хранения данных
        companies = []

        # Ищем элементы с информацией о компаниях (структура может отличаться)
        # Замечание: Реальная структура зависит от HTML 2GIS, нужно проверить через "Inspect"
        company_blocks = soup.select("div._1kf6gff")  # Примерный класс, нужно уточнить

        for block in company_blocks:
            # Извлекаем сайт компании
            website_link = block.find("a", class_="_pvu4ts1")  # Примерный класс для ссылки
            website = website_link['href'] if website_link and website_link.get('href', '').startswith('http') else "Не найдено"

            # Проверяем наличие обоих тегов (в предположении, что они видны в тексте)
            description = block.get_text().lower()
            if "типография" in description and "полиграфия" in description:
                companies.append({"website": website})

        return companies

    except requests.RequestException as e:
        print(f"Ошибка при загрузке страницы: {e}")
        return []

# Парсинг данных
company_data = parse_2gis()

# а) Сохранение в JSON
with open("2gis_typography.json", "w", encoding='utf-8') as json_file:
    json.dump(company_data, json_file, ensure_ascii=False, indent=4)
print("Данные сохранены в '2gis_typography.json'")

# б) Сохранение в XLSX
df = pd.DataFrame(company_data)
df.to_excel("2gis_typography.xlsx", index=False, engine='openpyxl')
print("Данные сохранены в '2gis_typography.xlsx'")